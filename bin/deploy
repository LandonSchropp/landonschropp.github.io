#!/usr/bin/env bash

set -euo pipefail

# TODO: Find a way to eliminate these hardcoded values.
FNM="/opt/homebrew/bin/fnm"
ENVIRONMENT_FILE="$HOME/Development/landonschropp.com/.envrc"

# Display a notification if the script fails.
FAILURE_MESSAGE="ðŸ˜µ Failed to deploy."
trap 'osascript -e "display notification \"'"$FAILURE_MESSAGE"'\" with title \"landonschropp.com\""' ERR

# Clone the repo to a temporary directory.
TEMP_DIR=$(mktemp -d)
git clone git@github.com:LandonSchropp/landonschropp.github.io.git "$TEMP_DIR"
cd "$TEMP_DIR"

# shellcheck disable=SC1090
source "$ENVIRONMENT_FILE"

# Set up pnpm and node
eval "$($FNM env --corepack-enabled)"
$FNM use --install-if-missing
corepack enable pnpm

# Install the dependencies
pnpm install

# Build the project
pnpm build

# Deploy the build
pnpm gh-pages --dist dist

# Display a notification if the deployment succeeds.
SUCCESS_MESSAGE="ðŸ¥³ landonschropp.com was successfully deployed!"
osascript -e 'display notification "'"$SUCCESS_MESSAGE"'" with title "landonschropp.com"'
